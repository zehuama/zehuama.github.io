<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-5-0實作使用者功能" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/12/5-0實作使用者功能/" class="article-date">
  <time datetime="2018-11-12T07:36:26.000Z" itemprop="datePublished">2018-11-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/12/5-0實作使用者功能/">5.0 實作使用者功能</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="本章的作業目標"><a href="#本章的作業目標" class="headerlink" title="本章的作業目標:"></a>本章的作業目標:</h2><ul>
<li><p><strong>安裝「登入系統」（使用 devise）</strong></p>
</li>
<li><p><strong>在 navbar 安裝登入/登出按鈕</strong></p>
</li>
<li><p><strong>客制登入畫面 ( 註冊, 登入, 修改帳號頁面 … etc)</strong></p>
</li>
<li><p><strong>利用 before_action :authenticate_user! 來做要求登入的設定</strong></p>
</li>
<li><p><strong>客製化 devise =&gt; 新增一個 “name” 的欄位</strong></p>
</li>
<li><p><strong>使用者功能 整合進 group / post 裡面 (作者機制)</strong></p>
</li>
<li><p><strong>只有作者才能有 group / post 的修改/刪除權限</strong></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/12/5-0實作使用者功能/" data-id="cjq24t7l8000no26c04p11n7q" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-5-1安装登入系统" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/12/5-1安装登入系统/" class="article-date">
  <time datetime="2018-11-12T07:42:12.000Z" itemprop="datePublished">2018-11-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/12/5-1安装登入系统/">5.1安装登入系统</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><br></p>
<h2 id="Step-0-git-checkout-b-ch05"><a href="#Step-0-git-checkout-b-ch05" class="headerlink" title="Step 0. git checkout -b ch05"></a>Step 0. git checkout -b ch05</h2><p>因为我们现在要实作第五章的内容，新增一个 branch 把实作内容集中在 ch05 是比较合理的。将来回顾就可以比较清楚 在 ch05 我们做了哪一些练习。</p>
<p><code>git checkout -b ch05</code></p>
<h1 id="Devise-簡介"><a href="#Devise-簡介" class="headerlink" title="Devise 簡介"></a>Devise 簡介</h1><p>  Devise 是一個 Rails 內熱門的 gem，專門用來快速實作「登入系統」。在這一章我們會用 devise 實作登入功能。</p>
<p><a href="https://github.com/plataformatec/devise" target="_blank" rel="noopener">devise</a></p>
<h1 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h1><h2 id="Step-1-安裝-gem-“devise”"><a href="#Step-1-安裝-gem-“devise”" class="headerlink" title="Step 1. 安裝 gem “devise”"></a>Step 1. 安裝 gem “devise”</h2><p>Gemfile 插入 『 gem ‘devise’ 』</p>
<figure class="highlight html"><figcaption><span>Gemfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem "devise", "~&gt; 4.0.0 "</span><br></pre></td></tr></table></figure>
<h2 id="Step-2-安裝"><a href="#Step-2-安裝" class="headerlink" title="Step 2. 安裝"></a>Step 2. 安裝</h2><p><code>bundle install</code></p>
<p>安裝新增的 gem</p>
<h2 id="Step-3-設定-Devise"><a href="#Step-3-設定-Devise" class="headerlink" title="Step 3. 設定 Devise"></a>Step 3. 設定 Devise</h2><ul>
<li><p>安裝 devise 必須檔案<br><code>rails g devise:install</code></p>
</li>
<li><p>產生一個有登入功能的 user model<br><code>rails g devise user</code></p>
</li>
<li><p>建立資料庫欄位<br><code>rake db:migrate</code></p>
</li>
</ul>
<h2 id="Step-4-重開-rails-server"><a href="#Step-4-重開-rails-server" class="headerlink" title="Step 4. 重開 rails server"></a>Step 4. 重開 rails server</h2><ul>
<li><p>別忘了重開 <code>rails server</code></p>
</li>
<li><p><strong>git 存档</strong><br><code>git add .</code><br><code>git commit -m &quot;install devise&quot;</code></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/12/5-1安装登入系统/" data-id="cjq24t7l9000oo26c9lbdu9j3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-5-2实际登入登出注册账号" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/12/5-2实际登入登出注册账号/" class="article-date">
  <time datetime="2018-11-12T09:22:13.000Z" itemprop="datePublished">2018-11-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/12/5-2实际登入登出注册账号/">5.2 实际登入登出注册账号</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="目標"><a href="#目標" class="headerlink" title="目標"></a>目標</h1><ul>
<li>我們希望在右上角可以實作「登入」、「登出」、「註冊功能」</li>
<li>利用 before_action :authenticate_user! 來做要求登入的設定</li>
</ul>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fx68dzs4zlj31kw0n6jul.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fx68ejwz32j31kw0o0q69.jpg" alt=""><br><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fx68enjlr6j31kw0q4wij.jpg" alt=""></p>
<h1 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h1><h2 id="Step-1-在-navbar-安裝登入-登出按鈕"><a href="#Step-1-在-navbar-安裝登入-登出按鈕" class="headerlink" title="Step 1: 在 navbar 安裝登入/登出按鈕"></a>Step 1: 在 navbar 安裝登入/登出按鈕</h2><figure class="highlight html"><figcaption><span>app/views/common/_navbar.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">+       <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> !<span class="attr">current_user</span> %&gt;</span></span><br><span class="line">+         <span class="tag">&lt;<span class="name">li</span>&gt;</span> <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("註冊", <span class="attr">new_user_registration_path</span>) %&gt;</span> <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">-         <span class="tag">&lt;<span class="name">li</span>&gt;</span> <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("登入", "#") %&gt;</span> <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">+         <span class="tag">&lt;<span class="name">li</span>&gt;</span> <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("登入", <span class="attr">new_user_session_path</span>) %&gt;</span> <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">+       <span class="tag">&lt;<span class="name">%</span> <span class="attr">else</span> %&gt;</span></span><br><span class="line">+         <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"dropdown"</span>&gt;</span></span><br><span class="line">+           <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"dropdown-toggle"</span> <span class="attr">data-toggle</span>=<span class="string">"dropdown"</span>&gt;</span></span><br><span class="line">+             Hi!, <span class="tag">&lt;<span class="name">%=</span> <span class="attr">current_user.email</span> %&gt;</span></span><br><span class="line">+             <span class="tag">&lt;<span class="name">b</span> <span class="attr">class</span>=<span class="string">"caret"</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">+           <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">+           <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span>&gt;</span></span><br><span class="line">+             <span class="tag">&lt;<span class="name">li</span>&gt;</span> <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("登出", <span class="attr">destroy_user_session_path</span>, <span class="attr">method:</span> <span class="attr">:delete</span>) %&gt;</span> <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">+           <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">+         <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">+       <span class="tag">&lt;<span class="name">%</span> <span class="attr">end</span> %&gt;</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="Step-2-啟動-Bootstrap-的下拉選單特效"><a href="#Step-2-啟動-Bootstrap-的下拉選單特效" class="headerlink" title="Step 2: 啟動 Bootstrap 的下拉選單特效"></a>Step 2: 啟動 Bootstrap 的下拉選單特效</h2><figure class="highlight html"><figcaption><span>app/assets/javascripts/application.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...(略)</span><br><span class="line"></span><br><span class="line">//= require turbolinks</span><br><span class="line">+ //= require bootstrap/dropdown</span><br><span class="line">//= require bootstrap/alert</span><br><span class="line">//= require_tree .</span><br><span class="line"></span><br><span class="line">...(略)</span><br></pre></td></tr></table></figure>
<h3 id="git-储存"><a href="#git-储存" class="headerlink" title="git 储存"></a>git 储存</h3><p><code>git add .</code><br><code>git commit -m &quot;user can login/logout/signup&quot;</code></p>
<h2 id="Step-3-利用-before-action-authenticate-user-來做要求登入的設定"><a href="#Step-3-利用-before-action-authenticate-user-來做要求登入的設定" class="headerlink" title="Step 3: 利用 before_action :authenticate_user! 來做要求登入的設定"></a>Step 3: 利用 before_action :authenticate_user! 來做要求登入的設定</h2><p>在 groups_controller.rb 加入<br><code>before_action :authenticate_user!</code></p>
<p>這是 devise 內建的功能，只要把它放進 controller 裡面，<br>就會自動驗證使用者是否入</p>
<p>if yes =&gt; 繼續下面的程序<br>if no =&gt; 轉到登入畫面</p>
<p>我們把這一行放進前面做的二個 controller : groups 跟 posts 裡面</p>
<figure class="highlight html"><figcaption><span>app/controllers/groups_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class GroupsController <span class="tag">&lt; <span class="attr">ApplicationController</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">+ <span class="attr">before_action</span> <span class="attr">:authenticate_user</span>!</span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight html"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class PostsController <span class="tag">&lt; <span class="attr">ApplicationController</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">+ <span class="attr">before_action</span> <span class="attr">:authenticate_user</span>!</span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br></pre></td></tr></table></figure>
<p>這時候進入 <a href="http://localhost:3000/groups" target="_blank" rel="noopener">http://localhost:3000/groups</a><br>就會出現下面的頁面</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fx68z7qceuj31kw0rkdje.jpg" alt=""></p>
<h3 id="new-create-edit-update-destroy-等-action-必須先登入才能操作"><a href="#new-create-edit-update-destroy-等-action-必須先登入才能操作" class="headerlink" title="new, create, edit, update, destroy 等 action 必須先登入才能操作"></a>new, create, edit, update, destroy 等 action 必須先登入才能操作</h3><p>我們會發現，不是所有 action 都一定要登入才行<br>只有跟 新增 / 修改 / 刪除 有關的 action 才需要先登入</p>
<figure class="highlight html"><figcaption><span>app/controllers/groups_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class GroupsController <span class="tag">&lt; <span class="attr">ApplicationController</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag"><span class="attr">-</span> <span class="attr">before_action</span> <span class="attr">:authenticate_user</span>!</span></span><br><span class="line"><span class="tag">+ <span class="attr">before_action</span> <span class="attr">:authenticate_user</span>!, <span class="attr">only:</span> [<span class="attr">:new</span>, <span class="attr">:edit</span>, <span class="attr">:create</span>, <span class="attr">:update</span>, <span class="attr">:destroy</span>]</span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br></pre></td></tr></table></figure>
<p>这个时候，不用登入也可以看到首页和show页面。<br>posts_controller 由於只有以上五個 action, 就不需要再設定 <code>only:</code><br><br></p>
<h3 id="devise-很聰明的幫我們把相關設定都做好了"><a href="#devise-很聰明的幫我們把相關設定都做好了" class="headerlink" title="devise 很聰明的幫我們把相關設定都做好了"></a>devise 很聰明的幫我們把相關設定都做好了</h3><p><code>rails g devise:views</code>  </p>
<p>devise 支援客制修改 template，可以用這行叫出(原本是隱藏的) devise views，以便修改</p>
<p>前后对比：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fx6avpb135j31kw0n6jul.jpg" alt=""><br><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fx6apvywk4j31kw0sa0wb.jpg" alt=""></p>
<p><strong>git 存档</strong><br><code>git add .</code><br><code>git commit -m &quot;limit user&quot;</code></p>
<h3 id="解说："><a href="#解说：" class="headerlink" title="解说："></a>解说：</h3><p><strong>current_user 是什么？</strong><br><code>current_user</code> 是 Devise 提供的“正在登入的当前用户”，你可以在 controller 或 view 里面使用它。</p>
<p><strong>!current_user 又是什么</strong><br><code>!</code> 表示不等于。<code>!current_user</code> 表示“现在没有登入的用户”（不在登入的状态）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/12/5-2实际登入登出注册账号/" data-id="cjq24t7la000po26c7tun7vdk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-5-3客制化Name栏位" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/13/5-3客制化Name栏位/" class="article-date">
  <time datetime="2018-11-13T03:55:01.000Z" itemprop="datePublished">2018-11-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/13/5-3客制化Name栏位/">5.3 客制化Name栏位</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Step-1-客製化-devise-gt-新增一個-“name”-的欄位"><a href="#Step-1-客製化-devise-gt-新增一個-“name”-的欄位" class="headerlink" title="Step 1: 客製化 devise =&gt; 新增一個 “name” 的欄位"></a>Step 1: 客製化 devise =&gt; 新增一個 “name” 的欄位</h2><p>devise 內建的資料格式並沒有 name 這個欄位，所以我們要客製化一個出來<br>新增一個資料庫異動設定, 名稱是 add_name_to_user ( user 表單新增一個 name 欄位)</p>
<p><code>rails g migration add_name_to_user</code></p>
<p>打開新增的檔案 <code>db/migrate/(一堆數字)_add_name_to_user.rb</code></p>
<figure class="highlight html"><figcaption><span>db/migrate/(一堆數字)_add_name_to_user.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class AddNameToUser <span class="tag">&lt; <span class="attr">ActiveRecord::Migration</span></span></span><br><span class="line"><span class="tag">  <span class="attr">def</span> <span class="attr">change</span></span></span><br><span class="line"><span class="tag">+   <span class="attr">add_column</span> <span class="attr">:users</span>, <span class="attr">:name</span>, <span class="attr">:string</span></span></span><br><span class="line"><span class="tag">  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"><span class="attr">end</span></span></span><br></pre></td></tr></table></figure>
<p>接下來跑 <code>rake db:migrate</code></p>
<p>這樣 user 資料庫就有 name 這個欄位了</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fx6c3nwu35j31dc0e00x7.jpg" alt=""><br><br></p>
<h2 id="Step-2-客製化-devise-的-views-gt-註冊頁面新增-name-欄位"><a href="#Step-2-客製化-devise-的-views-gt-註冊頁面新增-name-欄位" class="headerlink" title="Step 2: 客製化 devise 的 views =&gt; 註冊頁面新增 name 欄位"></a>Step 2: 客製化 devise 的 views =&gt; 註冊頁面新增 name 欄位</h2><p>打開 app/views/devise/registrations/new.html.erb</p>
<figure class="highlight html"><figcaption><span>app/views/devise/registrations/new.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-inputs"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:email</span>, <span class="attr">required:</span> <span class="attr">true</span>, <span class="attr">autofocus:</span> <span class="attr">true</span> %&gt;</span></span><br><span class="line">+   <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:name</span>,  <span class="attr">required:</span> <span class="attr">true</span> %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:password</span>, <span class="attr">required:</span> <span class="attr">true</span>, <span class="attr">hint:</span> ("#&#123;@<span class="attr">minimum_password_length</span>&#125; <span class="attr">characters</span> <span class="attr">minimum</span>" <span class="attr">if</span> @<span class="attr">validatable</span>) %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:password_confirmation</span>, <span class="attr">required:</span> <span class="attr">true</span> %&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fx6hxwbwelj31kw0p7n0b.jpg" alt=""></p>
<p>現在還只是前端的部分完成，後端還要再加一個設定，才能讓 name 輸入的值真正存到資料庫裡面<br>(還記得前面說的 <a href="http://rails101s.logdown.com/posts/211391-strong-parameters" target="_blank" rel="noopener">strong_params</a> 嗎？)<br><br></p>
<h2 id="Step-3-加入-strong-parameters-與-devise-整合的-hack"><a href="#Step-3-加入-strong-parameters-與-devise-整合的-hack" class="headerlink" title="Step 3: 加入 strong_parameters 與 devise 整合的 hack"></a>Step 3: 加入 strong_parameters 與 devise 整合的 hack</h2><p>打開 app/controller/application_controller</p>
<figure class="highlight html"><figcaption><span>app/controller/application_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class ApplicationController <span class="tag">&lt; <span class="attr">ActionController::Base</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">+ <span class="attr">before_filter</span> <span class="attr">:configure_permitted_parameters</span>, <span class="attr">if:</span> <span class="attr">:devise_controller</span>?</span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">+  <span class="attr">protected</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">+  <span class="attr">def</span> <span class="attr">configure_permitted_parameters</span></span></span><br><span class="line"><span class="tag">+   <span class="attr">devise_parameter_sanitizer.for</span>(<span class="attr">:sign_up</span>) &#123; |<span class="attr">u</span>| <span class="attr">u.permit</span>(<span class="attr">:name</span>, <span class="attr">:email</span>, <span class="attr">:password</span>, <span class="attr">:password_confirmation</span>) &#125;</span></span><br><span class="line"><span class="tag">+  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"><span class="attr">end</span></span></span><br></pre></td></tr></table></figure>
<p>如果出现<code>undefined method ‘for’ for Devise::ParameterSanitizer</code>的问题</p>
<p>尝试下面方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">devise_parameter_sanitizer.permit(:sign_up) &#123; |u| u.permit(:name, :email, :password, :password_confirmation) &#125;</span><br><span class="line">把 .for 改为 .permit</span><br></pre></td></tr></table></figure>
<p>這樣註冊新會員功能就完成了， 請新建立一個測試用帳號 來測試功能<br><br></p>
<h2 id="Step-4-navbar-上的-hi-email-改成-hi-name"><a href="#Step-4-navbar-上的-hi-email-改成-hi-name" class="headerlink" title="Step 4: navbar 上的 hi! email 改成 hi! name"></a>Step 4: navbar 上的 hi! email 改成 hi! name</h2><p>既然我們都能讓會員取名字了， navbar 上的 greeting 也該改成 name 吧？</p>
<p>打開 <code>app/views/common/_navbar.html.erb</code></p>
<figure class="highlight html"><figcaption><span>app/views/common/_navbar.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"dropdown"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"dropdown-toggle"</span> <span class="attr">data-toggle</span>=<span class="string">"dropdown"</span>&gt;</span></span><br><span class="line">-           Hi!, <span class="tag">&lt;<span class="name">%=</span> <span class="attr">current_user.email</span> %&gt;</span></span><br><span class="line">+           Hi!, <span class="tag">&lt;<span class="name">%=</span> <span class="attr">current_user.name</span> %&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">b</span> <span class="attr">class</span>=<span class="string">"caret"</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>before<br><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fx6ctnlk77j31kw0pwwib.jpg" alt=""></p>
<p>after<br><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fx6ctv94b8j31kw0nkgow.jpg" alt=""><br><br></p>
<h2 id="Step-5-新增-“帳號設定”-功能，並能修改自己帳號的-name"><a href="#Step-5-新增-“帳號設定”-功能，並能修改自己帳號的-name" class="headerlink" title="Step 5: 新增 “帳號設定” 功能，並能修改自己帳號的 name"></a>Step 5: 新增 “帳號設定” 功能，並能修改自己帳號的 name</h2><p>我們在前面章節也有創造一個帳號，但是卻還沒命名<br>所以需要做一個 “使用者帳號設定” 頁面來把<strong>還沒命名的帳號命名</strong></p>
<p>Devise 已經幫我們建好內建的功能<br>打開 <code>app/views/common/_navbar.html.erb</code></p>
<figure class="highlight html"><figcaption><span>app/views/common/_navbar.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span>&gt;</span></span><br><span class="line">+             <span class="tag">&lt;<span class="name">li</span>&gt;</span> <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("帳號設定", <span class="attr">edit_user_registration_path</span> )%&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">li</span>&gt;</span> <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("登出", <span class="attr">destroy_user_session_path</span>, <span class="attr">method:</span> <span class="attr">:delete</span>) %&gt;</span> <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>修改 edit_account 的 strong_parameters</p>
<figure class="highlight html"><figcaption><span>app/controller/application_controller</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">   def configure_permitted_parameters</span><br><span class="line">    devise_parameter_sanitizer.for(:sign_up) &#123; |u| u.permit(:name, :email, :password, :password_confirmation) &#125;</span><br><span class="line">+   devise_parameter_sanitizer.for(:account_update) &#123; |u| u.permit(:name, :email, :password, :password_confirmation, :current_password) &#125;</span><br><span class="line">   end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>在 app/views/devise/registrations/edit.html.erb 中 還要加入</p>
<figure class="highlight html"><figcaption><span>app/views/devise/registrations/edit.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-inputs"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:email</span>, <span class="attr">required:</span> <span class="attr">true</span>, <span class="attr">autofocus:</span> <span class="attr">true</span> %&gt;</span></span><br><span class="line">+   <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:name</span> %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:password</span>, <span class="attr">required:</span> <span class="attr">true</span>, <span class="attr">hint:</span> ("#&#123;@<span class="attr">minimum_password_length</span>&#125; <span class="attr">characters</span> <span class="attr">minimum</span>" <span class="attr">if</span> @<span class="attr">validatable</span>) %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:password_confirmation</span>, <span class="attr">required:</span> <span class="attr">true</span> %&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>也有可能你的 app/views/devise/registrations/edit.html.erb 长这样：<br><figure class="highlight html"><figcaption><span>app/views/devise/registrations/edit.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-inputs"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:email</span>, <span class="attr">required:</span> <span class="attr">true</span>, <span class="attr">autofocus:</span> <span class="attr">true</span> %&gt;</span></span><br><span class="line">+     <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:name</span> %&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> <span class="attr">devise_mapping.confirmable</span>? &amp;&amp; <span class="attr">resource.pending_reconfirmation</span>? %&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Currently waiting confirmation for: <span class="tag">&lt;<span class="name">%=</span> <span class="attr">resource.unconfirmed_email</span> %&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">%</span> <span class="attr">end</span> %&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:password</span>, <span class="attr">autocomplete:</span> "<span class="attr">off</span>", <span class="attr">hint:</span> "<span class="attr">leave</span> <span class="attr">it</span> <span class="attr">blank</span> <span class="attr">if</span> <span class="attr">you</span> <span class="attr">don</span>'<span class="attr">t</span> <span class="attr">want</span> <span class="attr">to</span> <span class="attr">change</span> <span class="attr">it</span>", <span class="attr">required:</span> <span class="attr">false</span> %&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:password_confirmation</span>, <span class="attr">required:</span> <span class="attr">false</span> %&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">%=</span> <span class="attr">f.input</span> <span class="attr">:current_password</span>, <span class="attr">hint:</span> "<span class="attr">we</span> <span class="attr">need</span> <span class="attr">your</span> <span class="attr">current</span> <span class="attr">password</span> <span class="attr">to</span> <span class="attr">confirm</span> <span class="attr">your</span> <span class="attr">changes</span>", <span class="attr">required:</span> <span class="attr">true</span> %&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fx6i8tu2f0j31kw0xaaes.jpg" alt=""></p>
<h2 id="Step-6-git存档"><a href="#Step-6-git存档" class="headerlink" title="Step 6: git存档"></a>Step 6: git存档</h2><p><code>git add .</code><br><code>git commit -m &quot;customize name for account&quot;</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/13/5-3客制化Name栏位/" data-id="cjq24t7lb000qo26c7df4oqso" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-6-1Group与User产生关联" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/15/6-1Group与User产生关联/" class="article-date">
  <time datetime="2018-11-15T02:37:41.000Z" itemprop="datePublished">2018-11-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/15/6-1Group与User产生关联/">6.1 让“Group”与“User”产生关联</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><br></p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><ul>
<li>我们要让“群组”记录是“被谁开的”。</li>
<li>并且在看板一览表显示出来“开设者的名称”</li>
</ul>
<h2 id="Step-0-git-checkout-b-ch06"><a href="#Step-0-git-checkout-b-ch06" class="headerlink" title="Step 0. git checkout -b ch06"></a>Step 0. git checkout -b ch06</h2><p><code>git checkout -b ch06</code></p>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="Step-1-新增-user-id-到-group-的-table-里"><a href="#Step-1-新增-user-id-到-group-的-table-里" class="headerlink" title="Step 1: 新增 user_id 到 group 的 table 里"></a>Step 1: 新增 user_id 到 group 的 table 里</h2><p>执行<br><code>rails g migration add_user_id_to_group</code></p>
<p>打開 db/migrate/(一堆數字) add_user_id_to_group.rb</p>
<p>原本</p>
<figure class="highlight html"><figcaption><span>db/migrate/(一堆數字)_add_user_id_to_group.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class AddUserIdToGroup <span class="tag">&lt; <span class="attr">ActiveRecord::Migration</span></span></span><br><span class="line"><span class="tag">  <span class="attr">def</span> <span class="attr">change</span></span></span><br><span class="line"><span class="tag">+  <span class="attr">add_column</span> <span class="attr">:groups</span>, <span class="attr">:user_id</span>, <span class="attr">:integer</span></span></span><br><span class="line"><span class="tag">  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"><span class="attr">end</span></span></span><br></pre></td></tr></table></figure>
<p>然后，执行<br><code>rake db:migrate</code></p>
<p>這樣 group 資料庫裡面，就多了 user_id 欄位</p>
<h2 id="Step-2-設定-user-跟-group-之間的資料庫關聯-database-relationship"><a href="#Step-2-設定-user-跟-group-之間的資料庫關聯-database-relationship" class="headerlink" title="Step 2: 設定 user 跟 group 之間的資料庫關聯 ( database relationship )"></a>Step 2: 設定 user 跟 group 之間的資料庫關聯 ( database relationship )</h2><p>修改 app/models/user.rb 加入 has_many :groups</p>
<figure class="highlight html"><figcaption><span>app/models/user.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class User <span class="tag">&lt; <span class="attr">ActiveRecord::Base</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag">+ <span class="attr">has_many</span> <span class="attr">:groups</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag"><span class="attr">end</span></span></span><br></pre></td></tr></table></figure>
<p>修改 app/models/group.rb</p>
<figure class="highlight html"><figcaption><span>app/models/group.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Group <span class="tag">&lt; <span class="attr">ActiveRecord::Base</span></span></span><br><span class="line"><span class="tag">  <span class="attr">validates</span> <span class="attr">:title</span>, <span class="attr">presence:</span> <span class="attr">true</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">has_many</span> <span class="attr">:posts</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">+ <span class="attr">belongs_to</span> <span class="attr">:user</span></span></span><br><span class="line"><span class="tag"><span class="attr">end</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Step-3-只有作者才能有-group-的修改-刪除權限"><a href="#Step-3-只有作者才能有-group-的修改-刪除權限" class="headerlink" title="Step 3: 只有作者才能有 group 的修改/刪除權限"></a>Step 3: 只有作者才能有 group 的修改/刪除權限</h2><p>打開 app/controllers/groups_controller.rb<br>只要找出 edit, create, update, destroy 這四個 action</p>
<figure class="highlight html"><figcaption><span>app/controllers/group_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">class GroupsController <span class="tag">&lt; <span class="attr">ApplicationController</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag">  <span class="attr">def</span> <span class="attr">edit</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">group</span> = <span class="string">Group.find(params[:id])</span></span></span><br><span class="line"><span class="tag">+   @<span class="attr">group.user</span> = <span class="string">current_user</span></span></span><br><span class="line"><span class="tag">  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">def</span> <span class="attr">create</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">group</span> = <span class="string">Group.new(group_params)</span></span></span><br><span class="line"><span class="tag">+   @<span class="attr">group.user</span> = <span class="string">current_user</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag">  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">def</span> <span class="attr">update</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">group</span> = <span class="string">Group.find(params[:id])</span></span></span><br><span class="line"><span class="tag">+   @<span class="attr">group.user</span> = <span class="string">current_user</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag">  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">def</span> <span class="attr">destroy</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">group</span> = <span class="string">Group.find(params[:id])</span></span></span><br><span class="line"><span class="tag">+   @<span class="attr">group.user</span> = <span class="string">current_user</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag">  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Step-4-git-储存"><a href="#Step-4-git-储存" class="headerlink" title="Step 4 : git 储存"></a>Step 4 : git 储存</h2><p><code>git add .</code><br><code>git commit -m &quot;add user_id to group&quot;</code></p>
<h2 id="Step-5-修改-group-列表，将-user-的名字列上去"><a href="#Step-5-修改-group-列表，将-user-的名字列上去" class="headerlink" title="Step 5 : 修改 group 列表，将 user 的名字列上去"></a>Step 5 : 修改 group 列表，将 user 的名字列上去</h2><p>修改 app/views/groups/index.html.erb 然后把 Creator 的资讯加进去。</p>
<figure class="highlight html"><figcaption><span>app/views/groups/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">  <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>#<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>Description<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">+   <span class="tag">&lt;<span class="name">td</span>&gt;</span>Creator <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>#<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>(<span class="attr">group.title</span>, <span class="attr">group_path</span>(<span class="attr">group</span>)) %&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">group.description</span> %&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">+   <span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">%=</span> <span class="attr">group.user.email</span> %&gt;</span> <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>做完之后，打开 <a href="http://localhost:3000/" target="_blank" rel="noopener">http://localhost:3000/</a> 会发现，首页怎么爆炸了。<br><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fx91k61lv4j30ll0cntaj.jpg" alt=""></p>
<p>别担心，这是因为我们之前创造的“群组”都是“无主”的。只要把这些“无主”的群组，通通删掉就行了。既然我们也进不去首页删群组了，我们就从 console 删吧。</p>
<h2 id="Step-6-删除所有“无主”的群组"><a href="#Step-6-删除所有“无主”的群组" class="headerlink" title="Step 6: 删除所有“无主”的群组"></a>Step 6: 删除所有“无主”的群组</h2><p>执行<br><code>rails console</code>            </p>
<p>然后输入</p>
<p><code>Group.delete_all</code><br><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fx91l2aty9j30xy06ugmu.jpg" alt=""></p>
<p>然后再打开 <a href="http://localhost:3000/" target="_blank" rel="noopener">http://localhost:3000/</a> 就正常了。<br><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fx91masqrdj31vy0m4416.jpg" alt=""></p>
<p>这时候我们再新增一笔资料，就会显示 creator 的资讯了。</p>
<h2 id="Step-7-git-存档"><a href="#Step-7-git-存档" class="headerlink" title="Step 7 : git 存档"></a>Step 7 : git 存档</h2><p><code>git add .</code><br><code>git commit -m &quot;show group&#39;s creator info &quot;</code></p>
<h3 id="解說"><a href="#解說" class="headerlink" title="解說"></a>解說</h3><p>運作邏輯是這樣:<br>create, edit, update, destroy 這四個 action 的運作</p>
<p>从原本只是單純呼叫 group 的資料庫來<br>找某筆資料 <code>.find(params[:id])</code>  or  建立一筆新資料 <code>.new(group_params)</code></p>
<p>加上 <code>@group.user = current_user</code></p>
<p>登入的使用者 current_user 和创建者 @group.user 就能相互关联，满足这个条件后，两者的数据就能打通<br>找某筆資料<code>.find(params[:id])</code> or 建立一筆新資料 <code>.new(group_params)</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/15/6-1Group与User产生关联/" data-id="cjq24t7lc000ro26cv0966h7f" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-6-2仅创始者可修改删除Group" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/15/6-2仅创始者可修改删除Group/" class="article-date">
  <time datetime="2018-11-15T11:52:22.000Z" itemprop="datePublished">2018-11-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/15/6-2仅创始者可修改删除Group/">6.2 只有群组的“创始者”可以“修改”“删除”群组资讯</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><ul>
<li>路人不应该可以看到“修改”“删除”按钮</li>
<li>只有群组的“创始者”可以实际执行“修改”“删除”群组资讯</li>
</ul>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="Step-1-路人不应该可以看到“修改”“删除”按钮"><a href="#Step-1-路人不应该可以看到“修改”“删除”按钮" class="headerlink" title="Step 1: 路人不应该可以看到“修改”“删除”按钮"></a>Step 1: 路人不应该可以看到“修改”“删除”按钮</h2><p>把“修改”“删除”藏起来，限定</p>
<ul>
<li>只有登入模式下</li>
<li>而且还必须是群组“创始者”</li>
</ul>
<p>才能看得到这个按钮，否则路人是看不到的。</p>
<p>修改 app/views/groups/index.html.erb<br>加入 <code>&lt;% if current_user &amp;&amp; current_user == group.user %&gt;</code> 的判断式</p>
<figure class="highlight html"><figcaption><span>app/views/groups/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">+       <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> <span class="attr">current_user</span> &amp;&amp; <span class="attr">current_user</span> == <span class="string">group.user</span> %&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("<span class="attr">Edit</span>", <span class="attr">edit_group_path</span>(<span class="attr">group</span>), <span class="attr">class:</span> "<span class="attr">btn</span> <span class="attr">btn-sm</span> <span class="attr">btn-default</span>")%&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("<span class="attr">Delete</span>", <span class="attr">group_path</span>(<span class="attr">group</span>),    <span class="attr">class:</span> "<span class="attr">btn</span> <span class="attr">btn-sm</span> <span class="attr">btn-default</span>",</span></span><br><span class="line"><span class="tag">                      <span class="attr">method:</span> <span class="attr">:delete</span>, <span class="attr">data:</span> &#123; <span class="attr">confirm:</span> "<span class="attr">Are</span> <span class="attr">you</span> <span class="attr">sure</span>?" &#125; )%&gt;</span></span><br><span class="line">+       <span class="tag">&lt;<span class="name">%</span> <span class="attr">end</span> %&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>重新刷新首页，路人现在就看不到按钮了。<br><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxa52h189pj31w60mogo8.jpg" alt=""></p>
<h2 id="Step-2-git-存档"><a href="#Step-2-git-存档" class="headerlink" title="Step 2: git 存档"></a>Step 2: git 存档</h2><p><code>git add .</code><br><code>git commit -m &quot;people can&#39;t see edit button unless he is group owner&quot;</code></p>
<h2 id="Step-3-若不是-group-創辦人，就不會顯示-edit-按鈕"><a href="#Step-3-若不是-group-創辦人，就不會顯示-edit-按鈕" class="headerlink" title="Step 3: 若不是 group 創辦人，就不會顯示 edit 按鈕"></a>Step 3: 若不是 group 創辦人，就不會顯示 edit 按鈕</h2><p>就算已經設定不是作者，按了 edit 也會跳 error</p>
<p>但不是作者還跑出 edit 來讓你按實在是很怪，對吧？</p>
<figure class="highlight html"><figcaption><span>app/views/groups/show.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"group"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("<span class="attr">New</span> <span class="attr">Post</span>", <span class="attr">new_group_post_path</span>(@<span class="attr">group</span>), <span class="attr">class:</span> "<span class="attr">btn</span> <span class="attr">btn-warning</span> <span class="attr">pull-right</span>") %&gt;</span></span><br><span class="line">+ <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> <span class="attr">current_user</span> &amp;&amp; <span class="attr">current_user</span> == <span class="string">@group.user</span> %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("<span class="attr">Edit</span>", <span class="attr">edit_group_path</span>(@<span class="attr">group</span>), <span class="attr">class:</span> "<span class="attr">btn</span> <span class="attr">btn-primary</span> <span class="attr">pull-right</span>") %&gt;</span></span><br><span class="line">+ <span class="tag">&lt;<span class="name">%</span> <span class="attr">end</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="Step-4-git-存档"><a href="#Step-4-git-存档" class="headerlink" title="Step 4: git 存档"></a>Step 4: git 存档</h2><p><code>git add .</code><br><code>git commit -m &quot;add permission check on show page&quot;</code></p>
<p>Before<br><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxa5cly9ajj31vy0nqjtt.jpg" alt=""></p>
<p>After<br><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxa5cwqqzoj31w00najtr.jpg" alt=""></p>
<h2 id="Step-5-必须要是-group-拥有人，才能进入-edit，否则会被重导至首页，并显示错误讯息。"><a href="#Step-5-必须要是-group-拥有人，才能进入-edit，否则会被重导至首页，并显示错误讯息。" class="headerlink" title="Step 5: 必须要是 group 拥有人，才能进入 edit，否则会被重导至首页，并显示错误讯息。"></a>Step 5: 必须要是 group 拥有人，才能进入 edit，否则会被重导至首页，并显示错误讯息。</h2><p>修改 app/controllers/groups_controller.rb 加入权限，如果不是“创始者”去存取，会显示没有权限的错误讯息。</p>
<figure class="highlight html"><figcaption><span>app/controllers/groups_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def edit</span><br><span class="line">  @group = Group.find(params[:id])</span><br><span class="line"></span><br><span class="line">  if current_user != @group.user</span><br><span class="line">    redirect_to groups_path, alert: "You have no permission."</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  @group.user = current_user</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>这样当其他人，试图输入 <a href="http://localhost:3000/groups/某笔资料的ID/edit" target="_blank" rel="noopener">http://localhost:3000/groups/某笔资料的ID/edit</a> 这样的网址，想要修改资料，就会被挡住。</p>
<h2 id="Step-6-依样画葫芦的把“权限检查”的程式码，套用到-update-destroy-上"><a href="#Step-6-依样画葫芦的把“权限检查”的程式码，套用到-update-destroy-上" class="headerlink" title="Step 6: 依样画葫芦的把“权限检查”的程式码，套用到 update / destroy 上"></a>Step 6: 依样画葫芦的把“权限检查”的程式码，套用到 update / destroy 上</h2><p>修改 app/controllers/groups_controller.rb 中的 update 与 destroy 部分。</p>
<figure class="highlight html"><figcaption><span>app/controllers/groups_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">def update</span><br><span class="line">  @group = Group.find(params[:id])</span><br><span class="line">  if current_user != @group.user</span><br><span class="line">    redirect_to groups_path, alert: "You have no permission."</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  @group.user = current_user</span><br><span class="line"></span><br><span class="line">  if @group.update(group_params)</span><br><span class="line">    redirect_to groups_path, notice: "修改讨论版成功"</span><br><span class="line">  else</span><br><span class="line">    render :edit</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">def destroy</span><br><span class="line">  @group = Group.find(params[:id]s)</span><br><span class="line"></span><br><span class="line">  if current_user != @group.user</span><br><span class="line">    redirect_to root_path, alert: "You have no permission."</span><br><span class="line">  else</span><br><span class="line">    @group.destroy</span><br><span class="line">    redirect_to groups_path, alert: "讨论版已删除"</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxa8guu28nj31ve0u0jw0.jpg" alt=""></p>
<p>##Step 7: git 存档<br><code>git add .</code><br><code>git commit -m &quot;check owner permission when access edit/update/destroy&quot;</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/15/6-2仅创始者可修改删除Group/" data-id="cjq24t7ld000so26c79e60z60" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-6-3仅创始者可修改删除Post" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/16/6-3仅创始者可修改删除Post/" class="article-date">
  <time datetime="2018-11-16T12:49:12.000Z" itemprop="datePublished">2018-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/16/6-3仅创始者可修改删除Post/">6.3 只有作者才能有 post 的修改/刪除權限</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="Step-1-新增-user-id-到-post-的-table-里"><a href="#Step-1-新增-user-id-到-post-的-table-里" class="headerlink" title="Step 1: 新增 user_id 到 post 的 table 里"></a>Step 1: 新增 user_id 到 post 的 table 里</h2><p>执行<br><code>rails g migration add_user_id_to_post user_id:integer</code></p>
<p>然后，执行<br><code>rake db:migrate</code></p>
<h2 id="Step-2-設定-user-跟-post-之間的資料庫關聯"><a href="#Step-2-設定-user-跟-post-之間的資料庫關聯" class="headerlink" title="Step 2: 設定 user 跟 post 之間的資料庫關聯"></a>Step 2: 設定 user 跟 post 之間的資料庫關聯</h2><p>打開 app/models/user.rb<br><figure class="highlight html"><figcaption><span>app/models/user.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class User <span class="tag">&lt; <span class="attr">ActiveRecord::Base</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag">  <span class="attr">has_many</span> <span class="attr">:groups</span></span></span><br><span class="line"><span class="tag">+ <span class="attr">has_many</span> <span class="attr">:posts</span></span></span><br><span class="line"><span class="tag"><span class="attr">end</span></span></span><br></pre></td></tr></table></figure></p>
<p>打開 app/models/post.rb<br>改成<br><figure class="highlight html"><figcaption><span>app/models/post.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Post <span class="tag">&lt; <span class="attr">ActiveRecord::Base</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag">+ <span class="attr">belongs_to</span> <span class="attr">:user</span></span></span><br><span class="line"><span class="tag"><span class="attr">end</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="Step-3-限定post的修改-删除权限-amp-amp-为创建post引入必要参数"><a href="#Step-3-限定post的修改-删除权限-amp-amp-为创建post引入必要参数" class="headerlink" title="Step 3: 限定post的修改/删除权限 &amp;&amp; 为创建post引入必要参数"></a>Step 3: 限定post的修改/删除权限 &amp;&amp; 为创建post引入必要参数</h2><p>打開 app/controllers/posts_controller.rb<br><figure class="highlight html"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">class PostsController <span class="tag">&lt; <span class="attr">ApplicationController</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag">  <span class="attr">def</span> <span class="attr">edit</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">post</span> = <span class="string">Post.find(params[:id])</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">    <span class="attr">if</span> <span class="attr">current_user</span> != <span class="string">@post.user</span></span></span><br><span class="line"><span class="tag">      <span class="attr">redirect_to</span> <span class="attr">group_path</span>(@<span class="attr">group</span>), <span class="attr">alert:</span> "<span class="attr">You</span> <span class="attr">have</span> <span class="attr">no</span> <span class="attr">permission.</span>"</span></span><br><span class="line"><span class="tag">    <span class="attr">end</span></span></span><br><span class="line"><span class="tag">  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">def</span> <span class="attr">create</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">post</span> = <span class="string">Post.new(post_params)</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">post.group</span> = <span class="string">@group</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">post.user</span> = <span class="string">current_user</span></span></span><br><span class="line"><span class="tag">    <span class="attr">if</span> @<span class="attr">post.save</span></span></span><br><span class="line"><span class="tag">      <span class="attr">redirect_to</span> <span class="attr">group_path</span>(@<span class="attr">group</span>), <span class="attr">notice:</span> "新增文章成功！"</span></span><br><span class="line"><span class="tag">    <span class="attr">else</span></span></span><br><span class="line"><span class="tag">      <span class="attr">render</span> <span class="attr">:new</span></span></span><br><span class="line"><span class="tag">    <span class="attr">end</span></span></span><br><span class="line"><span class="tag">  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">def</span> <span class="attr">update</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">post</span> = <span class="string">Post.find(params[:id])</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">post.group</span> = <span class="string">@group</span></span></span><br><span class="line"><span class="tag">    <span class="attr">if</span> <span class="attr">current_user</span> != <span class="string">@post.user</span></span></span><br><span class="line"><span class="tag">      <span class="attr">redirect_to</span> <span class="attr">group_path</span>(@<span class="attr">group</span>), <span class="attr">alert:</span> "<span class="attr">You</span> <span class="attr">have</span> <span class="attr">no</span> <span class="attr">permission.</span>"</span></span><br><span class="line"><span class="tag">    <span class="attr">end</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">post.user</span> = <span class="string">current_user</span></span></span><br><span class="line"><span class="tag">    <span class="attr">if</span> @<span class="attr">post.update</span>(<span class="attr">post_params</span>)</span></span><br><span class="line"><span class="tag">      <span class="attr">redirect_to</span> <span class="attr">group_path</span>(@<span class="attr">group</span>), <span class="attr">notice:</span> "文章修改成功！"</span></span><br><span class="line"><span class="tag">    <span class="attr">else</span></span></span><br><span class="line"><span class="tag">      <span class="attr">render</span> <span class="attr">:edit</span></span></span><br><span class="line"><span class="tag">    <span class="attr">end</span></span></span><br><span class="line"><span class="tag">  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">def</span> <span class="attr">destroy</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">post</span> = <span class="string">Post.find(params[:id])</span></span></span><br><span class="line"><span class="tag">    <span class="attr">if</span> <span class="attr">current_user</span> != <span class="string">@post.user</span></span></span><br><span class="line"><span class="tag">      <span class="attr">redirect_to</span> <span class="attr">group_path</span>(@<span class="attr">group</span>), <span class="attr">alert:</span> "<span class="attr">You</span> <span class="attr">have</span> <span class="attr">no</span> <span class="attr">permission.</span>"</span></span><br><span class="line"><span class="tag">    <span class="attr">else</span></span></span><br><span class="line"><span class="tag">      @<span class="attr">post.destroy</span></span></span><br><span class="line"><span class="tag">      <span class="attr">redirect_to</span> <span class="attr">group_path</span>(@<span class="attr">group</span>), <span class="attr">alert:</span> "文章已删除"</span></span><br><span class="line"><span class="tag">    <span class="attr">end</span></span></span><br><span class="line"><span class="tag">  <span class="attr">end</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fxbf2m0g2mj31s50u0n1x.jpg" alt=""></p>
<h2 id="Step-4-对非创建者隐藏post的修改-删除按键"><a href="#Step-4-对非创建者隐藏post的修改-删除按键" class="headerlink" title="Step 4: 对非创建者隐藏post的修改/删除按键"></a>Step 4: 对非创建者隐藏post的修改/删除按键</h2><p>打開 app/views/groups/show.html.erb<br><figure class="highlight html"><figcaption><span>app/views/groups/show.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">..</span><br><span class="line">..</span><br><span class="line">+     <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> <span class="attr">current_user</span> &amp;&amp; <span class="attr">current_user</span> == <span class="string">post.user</span> %&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("<span class="attr">Edit</span>", <span class="attr">edit_group_post_path</span>(<span class="attr">post.group</span>, <span class="attr">post</span>), <span class="attr">class:</span> "<span class="attr">btn</span> <span class="attr">btn-default</span> <span class="attr">btn-xs</span>")%&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("<span class="attr">Delete</span>", <span class="attr">group_post_path</span>(<span class="attr">post.group</span>, <span class="attr">post</span>), <span class="attr">class:</span> "<span class="attr">btn</span> <span class="attr">btn-default</span> <span class="attr">btn-xs</span>", <span class="attr">method:</span> <span class="attr">:delete</span>, <span class="attr">data:</span> &#123;<span class="attr">confirm:</span> "<span class="attr">Are</span> <span class="attr">you</span> <span class="attr">sure</span>?"&#125;) %&gt;</span></span><br><span class="line">+     <span class="tag">&lt;<span class="name">%</span> <span class="attr">end</span> %&gt;</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>之后刷新页面</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxbf3v7cx6j31w40r477j.jpg" alt=""></p>
<p>新增文章</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxbf58abrnj31q10u0tc9.jpg" alt=""></p>
<h3 id="將尚未做使用者功能前的-group-與-post-資料刪除"><a href="#將尚未做使用者功能前的-group-與-post-資料刪除" class="headerlink" title="將尚未做使用者功能前的 group 與 post 資料刪除"></a>將尚未做使用者功能前的 group 與 post 資料刪除</h3><p>當我們完成前面使用者登入的機制, 以及 group / post 擁有者機制的功能後</p>
<p>只要建立 group , 發表 post 都會要求登入</p>
<p>並且在建立之後會將把該筆資料的 user_id 欄位存進您的 user.id</p>
<p>這時候會遇到一個 bug: 之前所建立的 group 與 post 沒有 user_id 的值 ( nil )</p>
<p>後面的功能開發，需要驗證作者，若遇到沒有 user_id 的資料會導致出現 bug</p>
<h2 id="解決方法："><a href="#解決方法：" class="headerlink" title="解決方法："></a>解決方法：</h2><p>進入 rails console 模式<br><code>rails c</code></p>
<p>輸入以下指令:</p>
<p><code>Group.where(user_id: nil).destroy_all</code></p>
<p><code>Post.where(user_id: nil).destroy_all</code></p>
<p><code>Post.where(group_id: nil).destroy_all</code></p>
<p>或者</p>
<p><code>Group.delete_all</code> 之后重新创建</p>
<p>即可完成</p>
<h2 id="Step-5-git-储存"><a href="#Step-5-git-储存" class="headerlink" title="Step 5: git 储存"></a>Step 5: git 储存</h2><p><code>git add .</code><br><code>git commit -m &quot;only creater can edit/destroy post&quot;</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/16/6-3仅创始者可修改删除Post/" data-id="cjq24t7le000to26c8z03uhuc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-7-0创建社团" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/18/7-0创建社团/" class="article-date">
  <time datetime="2018-11-18T02:09:22.000Z" itemprop="datePublished">2018-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/18/7-0创建社团/">7.0 创建社团</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="本章目標"><a href="#本章目標" class="headerlink" title="本章目標"></a>本章目標</h1><ul>
<li>建立 討論版成員 ( group_user ) 設定</li>
<li>user 必須要是這個社團的成員才能發表文章</li>
<li>user 可以在 group 頁面 加入 / 退出 此 group</li>
<li>User 在建立 group 後自動成為 group 的一員</li>
<li>若不是 group 創辦人，就不會顯示 edit 按鈕</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/18/7-0创建社团/" data-id="cjq24t7lf000uo26c45klvwbh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-7-1建立讨论版成员及设定" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/18/7-1建立讨论版成员及设定/" class="article-date">
  <time datetime="2018-11-18T02:24:50.000Z" itemprop="datePublished">2018-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/18/7-1建立讨论版成员及设定/">7.1 建立讨论版成员及关系设定</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>建立群成员的关系表</p>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="Step-0-git-checkout-b-ch07"><a href="#Step-0-git-checkout-b-ch07" class="headerlink" title="Step 0. git checkout -b ch07"></a>Step 0. git checkout -b ch07</h2><p>因为我们现在要实作第六章的内容，新增一个 branch 把实作内容集中在 ch07 是比较合理的。将来回顾就可以比较清楚 在 ch07 我们做了哪一些练习。</p>
<p><code>git checkout -b ch07</code></p>
<h2 id="Step-1-建立-GroupRelationship"><a href="#Step-1-建立-GroupRelationship" class="headerlink" title="Step 1: 建立 GroupRelationship"></a>Step 1: 建立 GroupRelationship</h2><p>我们在这里要建立一个新的 model 叫 GroupRelationship。这个资料表里面只有两个栏位：</p>
<ul>
<li>group_id ( integer )</li>
<li>user_id ( integer)<br>记录了“谁”参加了“哪个群组”。</li>
</ul>
<p>输入</p>
<p><code>rails g model group_relationship group_id:integer user_id:integer</code></p>
<p>执行</p>
<p><code>rake db:migrate</code></p>
<h2 id="Step-2-设定-Group-与-User-之间的关系"><a href="#Step-2-设定-Group-与-User-之间的关系" class="headerlink" title="Step 2: 设定 Group 与 User 之间的关系"></a>Step 2: 设定 Group 与 User 之间的关系</h2><figure class="highlight html"><figcaption><span>app/models/user.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">   has_many :groups</span><br><span class="line">   has_many :posts</span><br><span class="line"></span><br><span class="line">+  has_many :group_relationships</span><br><span class="line">+  has_many :participated_groups, :through =&gt; :group_relationships, :source =&gt; :group</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>user.groups 会捞出这个使用者“创造过的所有群”。那我们要如何撰写 “参与的所有群”呢？</p>
<p>打開 app/models/group.rb<br><figure class="highlight html"><figcaption><span>app/models/group.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Group <span class="tag">&lt; <span class="attr">ActiveRecord::Base</span></span></span><br><span class="line"><span class="tag"><span class="attr">validates</span> <span class="attr">:title</span>, <span class="attr">presence:</span> <span class="attr">true</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">has_many</span> <span class="attr">:posts</span></span></span><br><span class="line"><span class="tag">+ <span class="attr">has_many</span> <span class="attr">:group_relationships</span></span></span><br><span class="line"><span class="tag">+ <span class="attr">has_many</span> <span class="attr">:members</span>, <span class="attr">through:</span> <span class="attr">:group_relationships</span>, <span class="attr">source:</span> <span class="attr">:user</span></span></span><br><span class="line"><span class="tag"><span class="attr">..</span></span></span><br><span class="line"><span class="tag"><span class="attr">..</span></span></span><br></pre></td></tr></table></figure></p>
<p>打開 app/models/group_user.rb<br>原本</p>
<figure class="highlight html"><figcaption><span>app/models/group_relationship.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class GroupRelationship <span class="tag">&lt; <span class="attr">ApplicationRecord</span></span></span><br><span class="line"><span class="tag">+ <span class="attr">belongs_to</span> <span class="attr">:user</span></span></span><br><span class="line"><span class="tag">+ <span class="attr">belongs_to</span> <span class="attr">:group</span></span></span><br><span class="line"><span class="tag"><span class="attr">end</span></span></span><br></pre></td></tr></table></figure>
<p>这样当捞 user.partcipated_groups 时，就会捞出“参与的所有群”。</p>
<h2 id="Step-3-git-储存"><a href="#Step-3-git-储存" class="headerlink" title="Step 3: git 储存"></a>Step 3: git 储存</h2><p><code>git add .</code><br><code>git commit -m &quot;implement group relation&quot;</code></p>
<h2 id="Step-4-动手测看看"><a href="#Step-4-动手测看看" class="headerlink" title="Step 4: 动手测看看"></a>Step 4: 动手测看看</h2><p>打开<br> <code>rails console</code></p>
<p>输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">u = User.first</span><br><span class="line">g = Group.first</span><br><span class="line">g.members &lt;&lt; u</span><br><span class="line">g.members</span><br><span class="line">u.participated_groups</span><br></pre></td></tr></table></figure></p>
<p>看看会出现什么结果。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxchj27is1j314b0u04as.jpg" alt=""></p>
<h2 id="解说："><a href="#解说：" class="headerlink" title="解说："></a>解说：</h2><p>可以花时间解释一下什么是 <code>has_many :through</code> 吗？</p>
<p><code>has_many :through</code>主要是在建立多对多关联资料库的时候使用。</p>
<p>例如一个“球队”可以有很多“球员”，一个“球员”可以参加很多“球队”，这个就是多对多关系。</p>
<p>在这里球员跟球队都是一个 Model，要建立多对多关系时我们会需要第三个 Model扮演连接的桥梁。</p>
<p>第三个 Model 就是“体育协会”，负责登记每个球员所属的球队以及球队目前的成员。如此一来我们就可以从体育协会得知每个球队和球员的状况（所以叫作“through”）。</p>
<p>所以“球员”throuth“体育协会”has_many“球队”，举例：</p>
<figure class="highlight html"><figcaption><span>models/player.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Player <span class="tag">&lt; <span class="attr">ActiveRecord::Base</span></span></span><br><span class="line"><span class="tag">    # 先告诉<span class="attr">model</span>我们在体育协会有很多笔资料</span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">    <span class="attr">has_many</span> <span class="attr">:sports_associations</span></span></span><br><span class="line"><span class="tag">  # 这些资料是要拿来判断这个球员有参与多少球队</span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">    <span class="attr">has_many</span> <span class="attr">:teams</span>, <span class="attr">:through</span> =&gt;</span> :sports_associations</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>models/team.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Team <span class="tag">&lt; <span class="attr">ActiveRecord::Base</span></span></span><br><span class="line"><span class="tag">    <span class="attr">has_many</span> <span class="attr">:sports_associations</span></span></span><br><span class="line"><span class="tag">    <span class="attr">has_many</span> <span class="attr">:players</span>, <span class="attr">:through</span> =&gt;</span> :sports_associations</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>models/sports_associations.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class SportsAssociations <span class="tag">&lt; <span class="attr">ActiveRecord::Base</span></span></span><br><span class="line"><span class="tag">    #体育协会要对球员和球队负责，所以体育球队<span class="attr">belongs_to</span>球员和球队</span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">    <span class="attr">belongs_to</span> <span class="attr">:team</span></span></span><br><span class="line"><span class="tag">    <span class="attr">belongs_to</span> <span class="attr">:player</span></span></span><br><span class="line"><span class="tag"><span class="attr">end</span></span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/18/7-1建立讨论版成员及设定/" data-id="cjq24t7lg000vo26c2280x0zd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-7-2判断“是否群组成员”" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/18/7-2判断“是否群组成员”/" class="article-date">
  <time datetime="2018-11-18T03:04:23.000Z" itemprop="datePublished">2018-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/18/7-2判断“是否群组成员”/">7.2 判断“是否为群组成员”</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><ul>
<li>会员要可以在社团里面看到自己“是否群组成员”</li>
<li>user 必須要是這個社團的成員才能發表文章</li>
</ul>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="Step-1-在-user-model-内实作“是否为成员一分子”的判断式-is-member-of-group"><a href="#Step-1-在-user-model-内实作“是否为成员一分子”的判断式-is-member-of-group" class="headerlink" title="Step 1. 在 user model 内实作“是否为成员一分子”的判断式 is_member_of?(group)"></a>Step 1. 在 user model 内实作“是否为成员一分子”的判断式 is_member_of?(group)</h2><p>打開 app/models/user.rb</p>
<figure class="highlight html"><figcaption><span>app/models/user.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">  has_many :group_users</span><br><span class="line">  has_many :participated_groups, through: :group_users, source: :group</span><br><span class="line"></span><br><span class="line">+ def is_member_of?(group)</span><br><span class="line">+   participated_groups.include?(group)</span><br><span class="line">+ end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="Step-2-user-必須要是這個社團的成員才能發表文章"><a href="#Step-2-user-必須要是這個社團的成員才能發表文章" class="headerlink" title="Step 2. user 必須要是這個社團的成員才能發表文章"></a>Step 2. user 必須要是這個社團的成員才能發表文章</h2><figure class="highlight html"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class PostsController <span class="tag">&lt; <span class="attr">ApplicationController</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">before_action</span> <span class="attr">:authenticate_user</span>!</span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">before_action</span> <span class="attr">:find_group</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">+ <span class="attr">before_action</span> <span class="attr">:member_required</span>, <span class="attr">only:</span> [<span class="attr">:new</span>, <span class="attr">:create</span> ]</span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag">  <span class="attr">private</span></span></span><br><span class="line"><span class="tag"><span class="attr">..</span></span></span><br><span class="line"><span class="tag"><span class="attr">..</span></span></span><br><span class="line"><span class="tag">+ <span class="attr">def</span> <span class="attr">member_required</span></span></span><br><span class="line"><span class="tag">+   <span class="attr">if</span> !<span class="attr">current_user.is_member_of</span>?(@<span class="attr">group</span>)</span></span><br><span class="line"><span class="tag">+     <span class="attr">flash</span>[<span class="attr">:warning</span>] = <span class="string">"你不是本讨论版的成员，不能发文喔！"</span></span></span><br><span class="line"><span class="tag">+     <span class="attr">redirect_to</span> <span class="attr">group_path</span>(@<span class="attr">group</span>)</span></span><br><span class="line"><span class="tag">+   <span class="attr">end</span></span></span><br><span class="line"><span class="tag">+ <span class="attr">end</span></span></span><br><span class="line"><span class="tag"><span class="attr">end</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Step-3-user-可以在-group-頁面-加入-退出-此-group"><a href="#Step-3-user-可以在-group-頁面-加入-退出-此-group" class="headerlink" title="Step 3. user 可以在 group 頁面 加入 / 退出 此 group"></a>Step 3. user 可以在 group 頁面 加入 / 退出 此 group</h2><p>定义关系 <code>join!</code> 和 <code>quit!</code><br><figure class="highlight html"><figcaption><span>app/models/user.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class User <span class="tag">&lt; <span class="attr">ActiveRecord::Base</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line"><span class="tag">+ <span class="attr">def</span> <span class="attr">join</span>!(<span class="attr">group</span>)</span></span><br><span class="line">+   participated_groups &lt;&lt; group</span><br><span class="line">+ end</span><br><span class="line">+</span><br><span class="line">+ def quit!(group)</span><br><span class="line">+   participated_groups.delete(group)</span><br><span class="line">+ end</span><br><span class="line"></span><br><span class="line"> def is_member_of?(group)</span><br><span class="line">   participated_groups.include?(group)</span><br><span class="line"> end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>实际操作“加入群组”或“退出群组”<br><figure class="highlight html"><figcaption><span>app/controllers/groups_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">+ def join</span><br><span class="line">+   @group = Group.find(params[:id])</span><br><span class="line">+</span><br><span class="line">+   if !current_user.is_member_of?(@group)</span><br><span class="line">+     current_user.join!(@group)</span><br><span class="line">+     flash[:notice] = "加入本讨论版成功！"</span><br><span class="line">+   else</span><br><span class="line">+     flash[:warning] = "你已经是本讨论版成员！"</span><br><span class="line">+   end</span><br><span class="line">+</span><br><span class="line">+   redirect_to group_path(@group)</span><br><span class="line">+ end</span><br><span class="line">+</span><br><span class="line">+ def quit</span><br><span class="line">+   @group = Group.find(params[:id])</span><br><span class="line">+</span><br><span class="line">+   if current_user.is_member_of?(@group)</span><br><span class="line">+     current_user.quit!(@group)</span><br><span class="line">+     flash[:alert] = "已退出本讨论版！"</span><br><span class="line">+   else</span><br><span class="line">+     flash[:warning] = "你不是本讨论版成员，无法退出"</span><br><span class="line">+   end</span><br><span class="line">+</span><br><span class="line">+   redirect_to group_path(@group)</span><br><span class="line">+ end</span><br><span class="line"></span><br><span class="line"> private</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h2 id="Step-4-修改路由"><a href="#Step-4-修改路由" class="headerlink" title="Step 4. 修改路由"></a>Step 4. 修改路由</h2><figure class="highlight html"><figcaption><span>config/routes</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line"> resources :groups do</span><br><span class="line">+   member do</span><br><span class="line">+     post :join</span><br><span class="line">+     post :quit</span><br><span class="line">+   end</span><br><span class="line"></span><br><span class="line">   resources :posts</span><br><span class="line"> end</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="Step-5-实作加入-退出按钮"><a href="#Step-5-实作加入-退出按钮" class="headerlink" title="Step 5. 实作加入/退出按钮"></a>Step 5. 实作加入/退出按钮</h2><figure class="highlight html"><figcaption><span>app/views/groups/show.html.erb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line"> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"group"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("<span class="attr">New</span> <span class="attr">Post</span>", <span class="attr">new_group_post_path</span>(@<span class="attr">group</span>), <span class="attr">class:</span> "<span class="attr">btn</span> <span class="attr">btn-warning</span> <span class="attr">pull-right</span>")%&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("<span class="attr">Edit</span>", <span class="attr">edit_group_path</span>(@<span class="attr">group</span>), <span class="attr">class:</span> "<span class="attr">btn</span> <span class="attr">btn-primary</span> <span class="attr">pull-right</span>")%&gt;</span></span><br><span class="line">+    <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> <span class="attr">current_user</span> &amp;&amp; <span class="attr">current_user.is_member_of</span>?(@<span class="attr">group</span>) %&gt;</span></span><br><span class="line">+      <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("<span class="attr">Quit</span> <span class="attr">Group</span>", <span class="attr">quit_group_path</span>(@<span class="attr">group</span>), <span class="attr">method:</span> <span class="attr">:post</span>, <span class="attr">class:</span> "<span class="attr">btn</span> <span class="attr">btn-danger</span>") %&gt;</span></span><br><span class="line">+    <span class="tag">&lt;<span class="name">%</span> <span class="attr">else</span> %&gt;</span></span><br><span class="line">+      <span class="tag">&lt;<span class="name">%=</span> <span class="attr">link_to</span>("<span class="attr">Join</span> <span class="attr">Group</span>", <span class="attr">join_group_path</span>(@<span class="attr">group</span>), <span class="attr">method:</span> <span class="attr">:post</span>, <span class="attr">class:</span> "<span class="attr">btn</span> <span class="attr">btn-info</span>") %&gt;</span></span><br><span class="line">+    <span class="tag">&lt;<span class="name">%</span> <span class="attr">end</span> %&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="Step-6-User-在建立-group-後自動成為-group-的一員"><a href="#Step-6-User-在建立-group-後自動成為-group-的一員" class="headerlink" title="Step 6. User 在建立 group 後自動成為 group 的一員"></a>Step 6. User 在建立 group 後自動成為 group 的一員</h2><p>當你創辦了 group ，卻還要手動再加入這個 group 不會很怪嗎？</p>
<figure class="highlight html"><figcaption><span>app/controllers/groups_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">  def create</span><br><span class="line">    @group = current_user.groups.new(group_params)</span><br><span class="line"></span><br><span class="line">    if @group.save</span><br><span class="line">+     current_user.join!(@group)</span><br><span class="line">      redirect_to groups_path, notice: "新增讨论版成功"</span><br><span class="line">    else</span><br><span class="line">      render :new</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"> ...</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxdgy3by00j31qa0u0n0s.jpg" alt=""></p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxdgyh1r74j31qb0u0gp6.jpg" alt=""></p>
<h2 id="Step-7-git-git-储存"><a href="#Step-7-git-git-储存" class="headerlink" title="Step 7. git git 储存"></a>Step 7. git git 储存</h2><p> <code>git add .</code><br> <code>git commit -m &quot;implement join/quit action&quot;</code></p>
<h2 id="解说："><a href="#解说：" class="headerlink" title="解说："></a>解说：</h2><p>member 是什么？它的规则是什么？<br>执行 <code>rake routes</code>，你会看到它产生的规则是 join_group_path(@group) ，“单数”。member 是单数。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxcipnncw2j30ho01nt8o.jpg" alt=""></p>
<p>还有一个东西，叫 collection，假设我们要做一个热门文章吧，叫做 hot，意思是“热门的文章”“们”，这时候我们就会用 collection。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxcipr6hhzj306902i3yd.jpg" alt=""></p>
<p>再执行 <code>rake routes</code></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxciq0wt1yj30iy0300t3.jpg" alt=""><br>在这边你只要先“背”起来：</p>
<ul>
<li>member （成员）是“单数”，不加 s</li>
<li>collection （集合）是“复数”，加 s</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/18/7-2判断“是否群组成员”/" data-id="cjq24t7lg000wo26clld2ep9r" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/11/21/11-1上传githubANDheroku/">11.1 上传 github &amp; heroku</a>
          </li>
        
          <li>
            <a href="/2018/11/21/10-2countercache优化效能/">10.2 counter cache 优化效能</a>
          </li>
        
          <li>
            <a href="/2018/11/20/10-1用seed-rb档自动建立资料库/">10.1用seed.rb档自动建立资料库</a>
          </li>
        
          <li>
            <a href="/2018/11/20/9-4使用scope整理query/">9.4 使用 scope 整理 query</a>
          </li>
        
          <li>
            <a href="/2018/11/20/9-3使用partial整理html/">9.3 使用partial整理html</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>